<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Disabling Parts of External Functions - BUTR Documentation</title><meta name=generator content="Hugo 0.107.0"><link href=https://butr.github.io/documentation//index.xml rel=alternate type=application/rss+xml><link rel=canonical href=https://butr.github.io/documentation/advanced/disabling-parts-of-external-functions/><link rel=stylesheet href=https://butr.github.io/documentation/css/theme.min.css><script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script>
<link rel=stylesheet href=https://butr.github.io/documentation/css/chroma.min.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>
<script src=https://butr.github.io/documentation/js/bundle.js></script><style>:root{}</style><meta property="og:title" content="Disabling Parts of External Functions"><meta property="og:description" content="Introduction Sometimes you need to use a game function, but with some parts disabled. For example, Clan.OnCompanionAdded not only adds a hero to the clan companion list, but also adds him to the hero list.
public void OnCompanionAdded(Hero companion) { _companionsCache.Add(companion); OnHeroAdded(companion); // Function that adds the hero to the hero list } But what if we don&rsquo;t want this? One way you could just copy the function and get the maintenance burden of it."><meta property="og:type" content="article"><meta property="og:url" content="https://butr.github.io/documentation/advanced/disabling-parts-of-external-functions/"><meta property="og:image" content="https://butr.github.io/documentation/images/og-image.png"><meta property="article:section" content="advanced"><meta property="article:published_time" content="2022-11-25T01:30:00+03:00"><meta property="article:modified_time" content="2022-11-25T01:30:00+03:00"><meta property="og:site_name" content="BUTR Documentation"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://butr.github.io/documentation/images/og-image.png"><meta name=twitter:title content="Disabling Parts of External Functions"><meta name=twitter:description content="Introduction Sometimes you need to use a game function, but with some parts disabled. For example, Clan.OnCompanionAdded not only adds a hero to the clan companion list, but also adds him to the hero list.
public void OnCompanionAdded(Hero companion) { _companionsCache.Add(companion); OnHeroAdded(companion); // Function that adds the hero to the hero list } But what if we don&rsquo;t want this? One way you could just copy the function and get the maintenance burden of it."><meta itemprop=name content="Disabling Parts of External Functions"><meta itemprop=description content="Introduction Sometimes you need to use a game function, but with some parts disabled. For example, Clan.OnCompanionAdded not only adds a hero to the clan companion list, but also adds him to the hero list.
public void OnCompanionAdded(Hero companion) { _companionsCache.Add(companion); OnHeroAdded(companion); // Function that adds the hero to the hero list } But what if we don&rsquo;t want this? One way you could just copy the function and get the maintenance burden of it."><meta itemprop=datePublished content="2022-11-25T01:30:00+03:00"><meta itemprop=dateModified content="2022-11-25T01:30:00+03:00"><meta itemprop=wordCount content="218"><meta itemprop=image content="https://butr.github.io/documentation/images/og-image.png"><meta itemprop=keywords content></head><body><div class=container><header><h1>BUTR Documentation</h1><a href=https://github.com/butr/documentation class=github><i class="fab fa-github"></i></a></header><div class=content-container><main><h1>Disabling Parts of External Functions</h1><h1 id=introduction>Introduction</h1><p>Sometimes you need to use a game function, but with some parts disabled. For example, <code>Clan.OnCompanionAdded</code> not only adds a hero to the clan companion list,
but also adds him to the hero list.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> OnCompanionAdded(Hero companion)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  _companionsCache.Add(companion);
</span></span><span style=display:flex><span>  OnHeroAdded(companion); <span style=color:#75715e>// Function that adds the hero to the hero list</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But what if we don&rsquo;t want this? One way you could just copy the function and get the maintenance burden of it.<br>Another way would be to use a Harmony reverse patch. You can get a copy of the function and manually manipulate the IL code to disable the <code>OnHeroAdded</code> call.<br>We suggest a higher level approach, based on <code>using</code> scopes and <code>IDisposable</code>.</p><h2 id=scoped-disabling-technique>Scoped Disabling Technique</h2><p><code>using</code> allows us to create a scope. While this scope is active, we use a harmony patch that disables the execution of the unwanted function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>new</span> AddCompanionActionHandler())
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Within this scope any call to `OnHeroAdded` will be skipped.</span>
</span></span><span style=display:flex><span>    oldLeader.Clan.OnCompanionAdded(oldLeader);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The Harmony patch</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AddCompanionActionHandler</span> : IDisposable
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> AddCompanionActionHandler() =&gt; AddCompanionActionPatch.SkipChange = <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Dispose() =&gt; AddCompanionActionPatch.SkipChange = <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AddCompanionActionPatch</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> SkipChange = <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> Enable(Harmony harmony)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span> &amp;
</span></span><span style=display:flex><span>            harmony.TryPatch(
</span></span><span style=display:flex><span>                original: AccessTools2.Method(<span style=color:#66d9ef>typeof</span>(Clan), <span style=color:#e6db74>&#34;OnHeroAdded&#34;</span>),
</span></span><span style=display:flex><span>                prefix: AccessTools2.Method(<span style=color:#66d9ef>typeof</span>(AddCompanionActionPatch), nameof(Prefix)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> Prefix() =&gt; !SkipChange;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=edit-meta>Last updated on 25 Nov 2022<br>Published on 25 Nov 2022<br><a href=https://github.com/butr/documentation/edit/master/advanced/disabling-parts-of-external-functions.md class=edit-page><i class="fas fa-pen-square"></i>&nbsp;Edit on GitHub</a></div><nav class=pagination><a class="nav nav-prev" href=https://butr.github.io/documentation/advanced/ title=Advanced><i class="fas fa-arrow-left" aria-hidden=true></i>&nbsp;Prev - Advanced</a>
<a class="nav nav-next" href=https://butr.github.io/documentation/advanced/switching-from-membertinfo-to-accesstools2/ title="Switching from MemberInfo to AccessTools2">Next - Switching from MemberInfo to AccessTools2 <i class="fas fa-arrow-right" aria-hidden=true></i></a></nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p></footer></main><div class=sidebar><nav class=open-menu><ul><li><a href=https://butr.github.io/documentation/>Home</a></li><li class=parent><a href=https://butr.github.io/documentation/advanced/>Advanced</a><ul class=sub-menu><li class=active><a href=https://butr.github.io/documentation/advanced/disabling-parts-of-external-functions/>Disabling Parts of External Functions</a></li><li><a href=https://butr.github.io/documentation/advanced/switching-from-membertinfo-to-accesstools2/>Switching from MemberInfo to AccessTools2</a></li><li><a href=https://butr.github.io/documentation/advanced/type-wrapping/>Type Wrapping</a></li></ul></li></ul></nav><div class=sidebar-footer></div></div></div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20><span class="fa-layers fa-fw"><i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i></span></a></div></body></html>